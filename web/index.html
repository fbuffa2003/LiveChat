<!DOCTYPE html>
<html lang=en>
    <head>
        <title>Sample App</title>
        <script src="//code.jquery.com/jquery-2.2.4.min.js"></script>
        <script src="//cdn.livechatinc.com/boilerplate/1.0.js"></script>
        <link rel="stylesheet" href="//cdn.livechatinc.com/boilerplate/1.0.css">
        <script type="text/javascript">
            function getPropertyValue(data, propertyName) {
                return undefined === data[propertyName] ? '' : data[propertyName];
            }
            LiveChat.on("customer_profile", function(data) {
                $('#visitorID').html(getPropertyValue(data, 'id'));
                $('#visitorName').html(getPropertyValue(data, 'name'));
                $('#visitorEmail').html(getPropertyValue(data, 'email'));
                $('#chatID').html(getPropertyValue(data.chat, 'id'));
                $('#groupID').html(getPropertyValue(data.chat, 'groupID'));
                $('#BpmUrl').html(getPropertyValue(data.chat, 'BpmUrl'));
            });

                    // String of address bpmâ€™online OData servise.
                    private const string serverUri = "http://0384564-sales-enterprise-marketing-service-enterprise-demo.bpmonline.com/0/ServiceModel/EntityDataService.svc/";
                    private const string authServiceUtri = "http://0384564-sales-enterprise-marketing-service-enterprise-demo.bpmonline.com/ServiceModel/AuthService.svc/Login";

                    // Links to XML name spaces.
                    private static readonly XNamespace ds = "http://schemas.microsoft.com/ado/2007/08/dataservices";
                    private static readonly XNamespace dsmd = "http://schemas.microsoft.com/ado/2007/08/dataservices/metadata";
                    private static readonly XNamespace atom = "http://www.w3.org/2005/Atom"; 
                    GetOdataCollectionByAuthByHttpExample("Administrator 2", "Administrator 2");
                    public static void GetOdataCollectionByAuthByHttpExample(string userName, string userPassword)
                        {
                            // Creating an authentication request.
                            var authRequest = HttpWebRequest.Create(authServiceUtri) as HttpWebRequest;
                            authRequest.Method = "POST";
                            authRequest.ContentType = "application/json";
                            var bpmCookieContainer = new CookieContainer();
                            // Including the cookie use into the request.
                            authRequest.CookieContainer = bpmCookieContainer;
                            // Receiving a stream associated with the authentication request.
                            using (var requesrStream = authRequest.GetRequestStream())
                            {
                                // Recording the BPMonline user accounts and additional request parameters into the stream.
                                using (var writer = new StreamWriter(requesrStream))
                                {
                                    writer.Write(@"{
                                                        ""UserName"":""" + userName + @""",
                                                        ""UserPassword"":""" + userPassword + @""",
                                                        ""SolutionName"":""TSBpm"",
                                                        ""TimeZoneOffset"":-120,
                                                        ""Language"":""Ru-ru""
                                                        }");
                                }
                            }
                            // Receiving an answer from the server. If the authentication is successful, cookies will placed in the
                            // bpmCookieContainer object and they may be used for further requests.
                            using (var response = (HttpWebResponse)authRequest.GetResponse())
                            {
                                // Creating a request for data reception from the OData service.
                                var dataRequest = HttpWebRequest.Create(serverUri + "ContactCollection?select=Id, Name")
                                                        as HttpWebRequest;
                                // The HTTP method GET is used to receive data.
                                dataRequest.Method = "GET";
                                // Adding pre-received authentication cookie to the data receipt request.
                                dataRequest.CookieContainer = bpmCookieContainer;
                                // Receiving a response from the server.
                                using (var dataResponse = (HttpWebResponse)dataRequest.GetResponse())
                                {
                                    // Uploading the server response to an xml-document for further processing.
                                    XDocument xmlDoc = XDocument.Load(dataResponse.GetResponseStream());
                                    // Receiving the collection of contact objects that comply with the request condition.
                                    var contacts = from entry in xmlDoc.Descendants(atom + "entry")
                                                   select new
                                                       {
                                                           Id = new Guid(entry.Element(atom + "content")
                                                                              .Element(dsmd + "properties")
                                                                              .Element(ds + "Id").Value),
                                                           Name = entry.Element(atom + "content")
                                                                       .Element(dsmd + "properties")
                                                                       .Element(ds + "Name").Value
                                                       };
                                    foreach (var contact in contacts)
                                    {
                                        // Implementing actions with contacts.
                                    }
                                }
                            } 
            
            
            
            
            
            
            LiveChat.init();
        </script>
    </head>
    <body>
        <div class="chat-plugin" id="chatPluginContainer">
            <ul class="chat-plugin__menu">
                <li class="chat-plugin__menu__item chat-plugin__menu__item--active"><a href=""><span class="app-icon app-icon-dashboard" title="Contact"></span></a></li>
            </ul>
            <section class="chat-plugin__content">
                <div class="chat-plugin__content--centered">
                    <p class="chat-plugin__p">
                     Hola!<br/>Seleccione un chat para ver el detalle.
                    </p>
                </div>
                <dl class="chat-plugin__dl">
                    <dt>Visitor ID</dt>
                    <dd id="visitorID"></dd>
                    <dt>Visitor Name</dt>
                    <dd id="visitorName"></dd>
                    <dt>Visitor Email</dt>
                    <dd id="visitorEmail"></dd>
                    <dt>Chat ID</dt>
                    <dd id="chatID"></dd>
                    <dt>Group ID</dt>
                    <dd id="groupID"></dd>
                    <dt>Bpm-Online URL</dt>
                    <dd id="visitorID"><a target="_blank" href="https://0384564-sales-enterprise-marketing-service-enterprise-demo.bpmonline.com/0/Nui/ViewModule.aspx#CardModuleV2/ContactPageV2/edit/a6f14ab1-5ab9-4c85-9c40-8cf5560919cc">Detalle Contacto</a></dd>
                </dl>
            </section>
        </div>
    </body>
</html>
